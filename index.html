<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">RPG Online P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="css/unchained.css">
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header / Conex√£o -->
    <header class="bg-zinc-900 p-4 border-b border-zinc-800 shadow-xl flex-none">
        <div class="max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <h1 class="text-2xl fantasy-font text-amber-500 hidden md:block">RPG Direct</h1>

            <div class="hidden md:flex items-center text-[11px] text-zinc-500 ml-auto">
                <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank" rel="noopener noreferrer" class="hover:text-zinc-300 underline underline-offset-2">GPL-3.0</a>
                <span class="mx-2">¬∑</span>
                <a href="https://github.com/jefbt/RPG-Direct" target="_blank" rel="noopener noreferrer" class="hover:text-zinc-300 underline underline-offset-2">Source</a>
                <span class="mx-2">¬∑</span>
                <span id="app-version" class="text-zinc-600">v...</span>
            </div>
            
            <div id="connection-setup" class="flex flex-wrap items-center gap-2 text-sm w-full md:w-auto justify-center md:justify-end">
                <select id="language-select" class="bg-zinc-800 border border-zinc-700 px-2 py-1 rounded text-white focus:outline-none focus:border-amber-500 text-center font-bold text-amber-100" title="Language">
                    <option value="pt-BR">Portugu√™s (BR)</option>
                    <option value="en">English (US)</option>
                    <option value="es">Espa√±ol</option>
                </select>

                <select id="player-symbol" class="bg-zinc-800 border border-zinc-700 px-2 py-1 rounded text-white focus:outline-none focus:border-amber-500 w-16 text-center font-bold text-amber-100" title="Seu s√≠mbolo" data-i18n-title="ui.playerSymbolTitle">
                    <option value="" data-i18n="ui.random">Aleat√≥rio</option>
                    <option value="‚öîÔ∏è">‚öîÔ∏è</option>
                    <option value="üõ°Ô∏è">üõ°Ô∏è</option>
                    <option value="üßô">üßô</option>
                    <option value="üßù">üßù</option>
                    <option value="üêâ">üêâ</option>
                    <option value="ü¶ä">ü¶ä</option>
                    <option value="üê∫">üê∫</option>
                    <option value="üî•">üî•</option>
                    <option value="‚ùÑÔ∏è">‚ùÑÔ∏è</option>
                    <option value="‚ö°">‚ö°</option>
                    <option value="üåô">üåô</option>
                    <option value="üé≤">üé≤</option>
                </select>
                <input type="text" id="player-name" placeholder="Seu Nick" data-i18n-placeholder="ui.yourNick" class="bg-zinc-800 border border-zinc-700 px-3 py-1 rounded text-white focus:outline-none focus:border-amber-500 w-28 font-bold text-amber-100 placeholder-zinc-500">

                <div id="my-id-display" class="bg-zinc-800 px-3 py-1 rounded border border-zinc-700 hidden flex items-center gap-2">
                    <span class="text-zinc-400">ID:</span>
                    <span id="peer-id" class="font-mono text-amber-400 select-all cursor-pointer hover:text-amber-300" title="Clique para copiar" data-i18n-title="ui.clickToCopy">...</span>
                    <!-- Bot√£o Reset ID -->
                    <button id="btn-reset-id" title="Gerar Novo ID" data-i18n-title="ui.generateNewId" class="ml-1 text-zinc-500 hover:text-amber-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    </button>
                </div>
                
                <div id="join-controls" class="flex gap-2">
                    <input type="text" id="remote-id" placeholder="ID do Mestre" data-i18n-placeholder="ui.gmId" class="bg-zinc-800 border border-zinc-700 px-2 py-1 rounded text-white focus:outline-none focus:border-amber-500 w-32 md:w-40">
                    <button id="btn-connect" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1 rounded font-bold transition" data-i18n="ui.join">Entrar</button>
                </div>

                <div id="status-display" class="ml-2 text-xs text-zinc-500 flex items-center gap-2">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
                </div>

                <div id="host-chat-controls" class="hidden flex gap-2 items-center">
                    <button id="btn-export-chat" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 px-3 py-1 rounded border border-zinc-700 text-xs font-bold" data-i18n="ui.exportChat">Exportar Chat</button>
                    <button id="btn-import-chat" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 px-3 py-1 rounded border border-zinc-700 text-xs font-bold" data-i18n="ui.importChat">Importar Chat</button>
                    <button id="btn-clear-chat" class="bg-red-900/40 hover:bg-red-800/50 text-red-200 px-3 py-1 rounded border border-red-900/50 text-xs font-bold" data-i18n="ui.clearChat">Limpar Chat</button>
                    <input type="file" id="chat-import-file" class="hidden" accept=".json,application/json">
                </div>
            </div>
        </div>
    </header>

    <!-- √Årea do Chat -->
    <!-- overflow-hidden no main for√ßa o scroll a ficar apenas no filho -->
    <main class="flex-1 max-w-4xl w-full mx-auto p-4 flex flex-col relative overflow-hidden min-h-0">
        
        <div id="chat-messages" class="chat-container flex-1 overflow-y-auto no-scrollbar space-y-3 p-2 transition-all duration-200 scroll-smooth">
            <div class="text-center text-zinc-600 text-sm italic py-4" data-i18n="ui.welcomeHtml">
                Bem-vindo ao RPG Direct. <br> 
                Defina seu nick acima. <br>
                Mestres: Compartilhem seu ID. Jogadores: Colem o ID e entrem.
            </div>
        </div>

        <!-- Bot√£o Scroll Down -->
        <button id="scroll-down-btn" onclick="scrollToBottom(true)" class="hidden-btn absolute bottom-6 right-6 bg-zinc-700/90 hover:bg-zinc-600 text-white p-3 rounded-full shadow-xl z-20 border border-zinc-600 backdrop-blur-sm" title="Ir para o final" data-i18n-title="ui.scrollToBottom">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
        </button>

        <!-- Modal Editor de Macro -->
        <div id="macro-editor" class="hidden absolute inset-0 bg-zinc-900/95 z-50 flex flex-col p-4 rounded-lg border border-zinc-700 overflow-y-auto">
            <h2 class="text-xl fantasy-font text-amber-500 mb-4 text-center" data-i18n="ui.macroEditor">Editor de Macro</h2>
            
            <div class="flex gap-2 mb-4">
                <input id="macro-name" type="text" maxlength="5" placeholder="Nome (ex: VNT)" data-i18n-placeholder="ui.macroName" class="bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-white w-1/2 focus:outline-none focus:border-amber-500">
                <select id="macro-icon" class="bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-white w-1/2 focus:outline-none focus:border-amber-500">
                    <option value="‚öîÔ∏è">‚öîÔ∏è Ataque</option>
                    <option value="üõ°Ô∏è">üõ°Ô∏è Defesa</option>
                    <option value="üî•">üî• Magia</option>
                    <option value="‚ù§Ô∏è">‚ù§Ô∏è Cura</option>
                    <option value="üíÄ">üíÄ Dano</option>
                    <option value="üé≤">üé≤ Dado</option>
                    <option value="‚ú®">‚ú® Especial</option>
                </select>
            </div>

            <!-- Paleta de Dados -->
            <div class="mb-2 text-xs text-zinc-400 text-center" data-i18n="ui.clickDieToAdd">Clique num dado para adicionar √† √°rea selecionada</div>
            <div class="flex flex-wrap justify-center gap-2 mb-4 p-2 bg-zinc-800 rounded border border-zinc-700">
                <button onclick="addDieToSelectedZone(4)" class="p-1 hover:bg-zinc-700 rounded">D4</button>
                <button onclick="addDieToSelectedZone(6)" class="p-1 hover:bg-zinc-700 rounded">D6</button>
                <button onclick="addDieToSelectedZone(8)" class="p-1 hover:bg-zinc-700 rounded">D8</button>
                <button onclick="addDieToSelectedZone(10)" class="p-1 hover:bg-zinc-700 rounded">D10</button>
                <button onclick="addDieToSelectedZone(12)" class="p-1 hover:bg-zinc-700 rounded">D12</button>
                <button onclick="addDieToSelectedZone(20)" class="p-1 hover:bg-zinc-700 rounded text-amber-500">D20</button>
                <button onclick="addDieToSelectedZone(100)" class="p-1 hover:bg-zinc-700 rounded">D100</button>
            </div>

            <!-- Zonas de Constru√ß√£o -->
            <div class="space-y-4 flex-1">
                
                <!-- Container Maior -->
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between items-center text-xs text-zinc-400">
                        <span data-i18n="ui.zoneHighest">Maior (Rola X, mant√©m maior)</span>
                        <button onclick="addGroupToSum('highest')" class="text-amber-500 hover:text-white font-bold border border-amber-500 rounded px-2" data-i18n="ui.addToSum">+ Adicionar √† Soma</button>
                    </div>
                    <div id="zone-highest" onclick="selectZone('highest')" class="drop-zone border-2 border-dashed border-zinc-700 rounded p-2 flex flex-wrap gap-1 items-center bg-zinc-800/50"></div>
                </div>

                <!-- Container Menor -->
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between items-center text-xs text-zinc-400">
                        <span data-i18n="ui.zoneLowest">Menor (Rola X, mant√©m menor)</span>
                        <button onclick="addGroupToSum('lowest')" class="text-amber-500 hover:text-white font-bold border border-amber-500 rounded px-2" data-i18n="ui.addToSum">+ Adicionar √† Soma</button>
                    </div>
                    <div id="zone-lowest" onclick="selectZone('lowest')" class="drop-zone border-2 border-dashed border-zinc-700 rounded p-2 flex flex-wrap gap-1 items-center bg-zinc-800/50"></div>
                </div>

                <!-- Container Soma (Principal) -->
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between items-center text-xs text-zinc-400">
                        <span class="text-amber-500 font-bold" data-i18n="ui.finalSum">Soma Final (Resultado)</span>
                        <div class="flex items-center gap-1">
                            <input type="number" id="mod-input" placeholder="+/-" class="w-12 bg-zinc-800 border border-zinc-600 rounded text-xs px-1 text-white">
                            <button onclick="addModToSum()" class="text-xs bg-zinc-700 hover:bg-zinc-600 px-2 py-1 rounded" data-i18n="ui.addMod">Add Mod</button>
                        </div>
                    </div>
                    <div id="zone-sum" onclick="selectZone('sum')" class="drop-zone border-2 border-amber-700/50 rounded p-2 flex flex-wrap gap-1 items-center bg-zinc-800 min-h-[80px]"></div>
                </div>

            </div>

            <!-- Footer do Modal -->
            <div class="mt-4 flex flex-wrap justify-between gap-2">
                <div class="flex gap-2">
                    <button onclick="importMacro()" class="text-xs text-zinc-500 hover:text-zinc-300" data-i18n="ui.import">Importar</button>
                    <button onclick="exportMacro()" class="text-xs text-zinc-500 hover:text-zinc-300" data-i18n="ui.export">Exportar</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteMacro()" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-3 py-1 rounded text-sm" data-i18n="ui.delete">Apagar</button>
                    <button onclick="closeMacroEditor()" class="bg-zinc-700 hover:bg-zinc-600 text-white px-3 py-1 rounded text-sm" data-i18n="ui.cancel">Cancelar</button>
                    <button onclick="saveMacro()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-1 rounded text-sm font-bold" data-i18n="ui.save">Salvar</button>
                </div>
            </div>
            
            <input type="file" id="macro-file-input" class="hidden" accept=".json" onchange="handleFileImport(this)">
        </div>
    </main>

    <!-- Painel de Dados e Input -->
    <footer class="bg-zinc-900 border-t border-zinc-800 p-2 md:p-4 flex-none">
        <div class="max-w-4xl mx-auto space-y-2">
            
            <!-- Bot√µes de Dados + Macro -->
            <div class="flex flex-wrap justify-center gap-2 mb-1 items-center">
                <!-- Bot√£o Toggle Dados Padr√£o -->
                <button id="toggle-dice-btn" class="p-2 text-zinc-500 hover:text-zinc-300 mr-1" title="Mostrar/Ocultar Dados Padr√£o" data-i18n-title="ui.toggleDice">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>

                <button onclick="rollDice(event, 4)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-zinc-500">D4</span><span class="text-base">‚ñ≤</span>
                </button>
                <button onclick="rollDice(event, 6)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-zinc-500">D6</span><span class="text-base">‚ñ†</span>
                </button>
                <button onclick="rollDice(event, 8)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-zinc-500">D8</span><span class="text-base">‚ß´</span>
                </button>
                <button onclick="rollDice(event, 10)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-zinc-500">D10</span><span class="text-base">‚¨•</span>
                </button>
                <button onclick="rollDice(event, 12)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-zinc-500">D12</span><span class="text-base">‚¨¢</span>
                </button>
                <button onclick="rollDice(event, 20)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-amber-900/40 hover:bg-amber-800/40 border border-amber-700/50 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-amber-500">D20</span><span class="text-base text-amber-400 font-bold">‚òÖ</span>
                </button>
                <button onclick="rollDice(event, 100)" title="Clique: Rolar | Ctrl+Clique: Para Mestre | Shift+Clique: √Äs Cegas" data-i18n-title="ui.diceHelp" class="standard-die dice-btn bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded flex flex-col items-center min-w-[45px]">
                    <span class="text-[10px] text-zinc-500">D100</span><span class="text-base">%</span>
                </button>
                
                <!-- Divisor -->
                <div class="w-[1px] bg-zinc-700 mx-1 h-8"></div>

                <!-- Bot√£o Criar Macro -->
                <button onclick="openMacroEditor(true)" title="Criar Macro" data-i18n-title="ui.createMacro" class="dice-btn bg-emerald-900/40 hover:bg-emerald-800/40 border border-emerald-700/50 p-2 rounded flex flex-col items-center justify-center min-w-[45px]">
                    <span class="text-xl font-bold text-emerald-400">+</span>
                </button>

                <!-- Container para Macros Salvos -->
                <div id="macros-container" class="flex gap-2"></div>
            </div>

            <!-- Modos de Rolagem -->
            <div class="flex justify-center gap-1 mb-2 overflow-x-auto no-scrollbar pb-1">
                <label class="cursor-pointer select-none">
                    <input type="radio" name="roll-mode" value="open" checked class="roll-mode-radio hidden">
                    <div class="px-3 py-1 rounded-full border text-[10px] font-bold transition-colors" data-i18n="ui.rollModeOpen">Aberto</div>
                </label>
                <label class="cursor-pointer select-none">
                    <input type="radio" name="roll-mode" value="gm" class="roll-mode-radio hidden">
                    <div class="px-3 py-1 rounded-full border text-[10px] font-bold transition-colors" data-i18n="ui.rollModeGm">Mestre</div>
                </label>
                <label class="cursor-pointer select-none">
                    <input type="radio" name="roll-mode" value="blind" class="roll-mode-radio hidden">
                    <div class="px-3 py-1 rounded-full border text-[10px] font-bold transition-colors" data-i18n="ui.rollModeBlind">√Äs Cegas</div>
                </label>
                <label class="cursor-pointer select-none">
                    <input type="radio" name="roll-mode" value="group" class="roll-mode-radio hidden">
                    <div class="px-3 py-1 rounded-full border text-[10px] font-bold transition-colors" data-i18n="ui.rollModeGroup">Grupo</div>
                </label>
                <label class="cursor-pointer select-none">
                    <input type="radio" name="roll-mode" value="self" class="roll-mode-radio hidden">
                    <div class="px-3 py-1 rounded-full border text-[10px] font-bold transition-colors" data-i18n="ui.rollModeSelf">Eu</div>
                </label>
            </div>

            <!-- Container Flex para Destinat√°rios e Bot√£o Grupo -->
            <div class="flex items-center justify-between px-1 mb-1">
                <div id="recipients-container" class="flex flex-wrap gap-2 text-xs items-center">
                    <span class="text-zinc-500 mr-1 noselect" data-i18n="ui.chatTo">Chat Para:</span>
                </div>

                <label class="cursor-pointer select-none inline-flex items-center ml-2 shrink-0" title="Mostrar destinat√°rios na mensagem" data-i18n-title="ui.showRecipientsTitle">
                    <input type="checkbox" id="group-toggle" checked class="hidden peer">
                    <div class="px-2 py-1 rounded border text-[10px] uppercase font-bold transition-colors border-zinc-700 bg-zinc-800 text-zinc-400 peer-checked:bg-emerald-600 peer-checked:text-white peer-checked:border-emerald-600">
                        <span data-i18n="ui.visibleNames">Nomes Vis√≠veis</span>
                    </div>
                </label>
            </div>

            <!-- Contexto de Resposta -->
            <div id="reply-context-bar" class="hidden flex items-center justify-between bg-zinc-800/80 border-l-4 border-amber-500 px-3 py-1 mb-1 rounded text-xs">
                <div class="flex flex-col overflow-hidden">
                    <span class="text-amber-500 font-bold" id="reply-target-name" data-i18n="ui.replyingTo">Respondendo a...</span>
                    <span class="text-zinc-400 truncate max-w-[300px]" id="reply-target-msg">...</span>
                </div>
                <button onclick="cancelReply()" class="text-zinc-500 hover:text-white p-1">‚úï</button>
            </div>

            <!-- Input -->
            <div class="flex gap-2">
                <label class="bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 cursor-pointer hover:bg-zinc-700 text-zinc-400 hover:text-white flex items-center justify-center" title="Enviar Imagem" data-i18n-title="ui.sendImage">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <input type="file" id="image-input" accept="image/*" class="hidden">
                </label>
                <input type="text" id="chat-input" placeholder="Digite uma mensagem... (Cole imagens aqui)" data-i18n-placeholder="ui.typeMessage" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 focus:outline-none focus:border-amber-600 text-white">
                <button id="btn-send" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg font-bold" data-i18n="ui.send">Enviar</button>
            </div>
        </div>
    </footer>

    <script type="module" src="js/unchained/bootstrap.js"></script>
</body>
</html>